#!/bin/sh
#MISE description="Bump workspace version in Cargo.toml"
#MISE alias="bump"

set -e

VERSION="${1:-}"

if [ -z "$VERSION" ]; then
    echo "Usage: mise run release:version-bump <version>"
    echo "Example: mise run release:version-bump 0.2.0"
    echo ""
    echo "Current version:"
    grep -E '^version = "[0-9]+\.[0-9]+\.[0-9]+"' Cargo.toml | head -1
    exit 1
fi

# Validate version format (semantic versioning)
if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
    echo "ERROR: Invalid version format"
    echo "Use semantic versioning (e.g., 0.2.0 or 0.2.0-beta.1)"
    exit 1
fi

CURRENT_VERSION=$(grep -E '^version = "[0-9]+\.[0-9]+\.[0-9]+"' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')

echo "Current version: $CURRENT_VERSION"
echo "New version:     $VERSION"
echo ""

# Update workspace version
sed -i "s/^version = \"$CURRENT_VERSION\"/version = \"$VERSION\"/" Cargo.toml

# Verify the change
NEW_VERSION=$(grep -E '^version = "[0-9]+\.[0-9]+\.[0-9]+"' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')

if [ "$NEW_VERSION" = "$VERSION" ]; then
    echo "Version bumped to $VERSION"
    echo ""
    echo "Next steps:"
    echo "  1. Update CHANGELOG.md with release date"
    echo "  2. Run: cargo check (to update Cargo.lock)"
    echo "  3. Commit changes"
else
    echo "ERROR: Version bump failed"
    exit 1
fi
